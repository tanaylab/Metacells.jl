
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Spheres · Metacells.jl v0.1.0
</title>
<meta name="title" content="Spheres · Metacells.jl v0.1.0"/>
<meta property="og:title" content="Spheres · Metacells.jl v0.1.0"/>
<meta property="twitter:title" content="Spheres · Metacells.jl v0.1.0"/>
<meta name="description" content="Documentation for Metacells.jl v0.1.0."/>
<meta property="og:description" content="Documentation for Metacells.jl v0.1.0."/>
<meta property="twitter:description" content="Documentation for Metacells.jl v0.1.0."/>
<script data-outdated-warner src="assets/warner.js">
</script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/>
<script>documenterBaseURL="."
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js">
</script>
<script src="search_index.js">
</script>
<script src="siteinfo.js">
</script>
<script src="../versions.js">
</script>
<link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/>
<link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/>
<script src="assets/themeswap.js">
</script>
</head>
<body>
<div id="documenter">
<nav class="docs-sidebar">
<div class="docs-package-name">
<span class="docs-autofit">
<a href="index.html">Metacells.jl v0.1.0
</a>
</span>
</div>
<button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)
</button>
<ul class="docs-menu">
<li>
<a class="tocitem" href="index.html">Metacells
</a>
</li>
<li>
<a class="tocitem" href="anndata_format.html">AnnData Format
</a>
</li>
<li>
<a class="tocitem" href="identify_genes.html">Identify Genes
</a>
</li>
<li class="is-active">
<a class="tocitem" href="spheres.html">Spheres
</a>
<ul class="internal">
<li>
<a class="tocitem" href="#Index">
<span>Index
</span>
</a>
</li>
</ul>
</li>
</ul>
<div class="docs-version-selector field has-addons">
<div class="control">
<span class="docs-label button is-static is-size-7">Version
</span>
</div>
<div class="docs-selector control is-expanded">
<div class="select is-fullwidth is-size-7">
<select id="documenter-version-selector">
</select>
</div>
</div>
</div>
</nav>
<div class="docs-main">
<header class="docs-navbar">
<a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#">
</a>
<nav class="breadcrumb">
<ul class="is-hidden-mobile">
<li class="is-active">
<a href="spheres.html">Spheres
</a>
</li>
</ul>
<ul class="is-hidden-tablet">
<li class="is-active">
<a href="spheres.html">Spheres
</a>
</li>
</ul>
</nav>
<div class="docs-right">
<a class="docs-navbar-link" href="https://github.com/tanaylab/Metacells.jl/blob/main{path}?plain=1#L{line}" title="View the repository on GitHub">
<span class="docs-icon fa-brands">
</span>
<span class="docs-label is-hidden-touch">GitHub
</span>
</a>
<a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings">
</a>
<a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings">
</a>
</div>
</header>
<article class="content" id="documenter-page">
<h1 id="Spheres">
<a class="docs-heading-anchor" href="#Spheres">Spheres
</a>
<a id="Spheres-1">
</a>
<a class="docs-heading-anchor-permalink" href="#Spheres" title="Permalink">
</a>
</h1>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Metacells.Spheres" href="#Metacells.Spheres">
<code>Metacells.Spheres
</code>
</a> — 
<span class="docstring-category">Module
</span>
</header>
<section>
<div>
<p>Given a set of raw metacells, partition them into spheres such that all metacells in the same sphere are within some (fold factor) radius of each other. The centroids of these spheres can serve as a representation of the cell state manifold which is less sensitive to oversampling of common cell states. Group these spheres in overlapping neighborhoods of &quot;similar&quot; spheres for further analysis.
</p>
</div>
</section>
</article>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Metacells.Spheres.compute_improved_spheres!" href="#Metacells.Spheres.compute_improved_spheres!">
<code>Metacells.Spheres.compute_improved_spheres!
</code>
</a> — 
<span class="docstring-category">Function
</span>
</header>
<section>
<div>
<pre>
<code class="language-julia hljs">function compute_improved_spheres!(
    daf::DafWriter;
    min_significant_gene_UMIs::Integer = 40,
    gene_fraction_regularization::AbstractFloat = 1e-5,
    confidence::AbstractFloat = 0.9,
    max_sphere_diameter::AbstractFloat = 2.0,
    max_neighborhood_diameter::AbstractFloat = 2.0,
    noisy_gene_fold::AbstractFloat = 1.0,
    min_gene_correlation::AbstractFloat = 0.5,
)::Nothing
</code>
</pre>
<p>Partition raw metacells into distinct spheres, and spheres into overlapping neighborhoods, such that each sphere is homogeneous in the genes that participate in multi-gene behaviors in its main neighborhood.
</p>
<p>This calls 
<a href="spheres.html#Metacells.Spheres.compute_spheres!">
<code>compute_spheres!
</code>
</a> and then 
<a href="spheres.html#Metacells.Spheres.improve_spheres!">`improve_spheres!
</a>. In the 1st call to 
<a href="spheres.html#Metacells.Spheres.compute_spheres!">
<code>compute_spheres!
</code>
</a> call, we allow up to 
<code>max_deviant_genes_fraction
</code> of the genes to be deviant; in 
<a href="spheres.html#Metacells.Spheres.improve_spheres!">
<code>improve_spheres!
</code>
</a>, we forbid all genes from being deviant, as we expect to ignore all &quot;irrelevant&quot; genes as non-markers or lonely.
</p>
<p>CONTRACT
</p>
</div>
</section>
</article>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Metacells.Spheres.compute_spheres!" href="#Metacells.Spheres.compute_spheres!">
<code>Metacells.Spheres.compute_spheres!
</code>
</a> — 
<span class="docstring-category">Function
</span>
</header>
<section>
<div>
<pre>
<code class="language-julia hljs">function compute_spheres!(
    daf::DafWriter;
    min_significant_gene_UMIs::Integer = 40,
    gene_fraction_regularization::AbstractFloat = 1e-5,
    confidence::AbstractFloat = 0.9,
    max_sphere_diameter::AbstractFloat = 2.0,
    max_neighborhood_diameter::AbstractFloat = 2.0,
    noisy_gene_fold::AbstractFloat = 1.0,
    max_deviant_genes::Integer = 0,
    overwrite::Bool = false,
)::Nothing
</code>
</pre>
<p>Partition raw metacells into distinct spheres, and spheres into overlapping neighborhoods.
</p>
<div class="admonition is-info">
<header class="admonition-header">Note
</header>
<div class="admonition-body">
<p>This is a lower-level function; you probably want to call 
<a href="spheres.html#Metacells.Spheres.compute_improved_spheres!">
<code>compute_improved_spheres!
</code>
</a> instead.
</p>
</div>
</div>
<ol>
<li>Compute a distance between each two metacells, defined as the maximal fold factor of any of the genes. This fold factor is the absolute value of the difference in the log base 2 of the fraction of the gene in both metacells, using the 
<code>gene_fraction_regularization
</code> (by default, 
<code>1e-5
</code>). Since the fraction of the gene is a random variable, we decrease the high fraction and increase the low fraction by a factor based on the 
<code>confidence
</code> of the test (by default, 0.9), assuming a multinomial distribution. In addition, if the sum of the total UMIs of the gene in both metacells is less than 
<code>min_significant_gene_UMIs
</code> (by default, 
<code>40
</code>), we ignore this fold factor as insignificant. We also ignore the fold factors for genes that aren&#39;t 
<code>is_marker
</code> in the vicinity of at least one of the metacells, or that are 
<code>is_lonely
</code> in the vicinity of both. For 
<code>is_noisy_gene_fold
</code> genes, we reduce the distance by 
<code>noisy_gene_fold
</code> to allow for their bursty nature.
</li>
<li>If 
<code>max_deviant_genes
</code> is not zero, we redefine the distance between metacells to be the number of genes with a maximal fold distance above the 
<code>max_sphere_diameter
</code> (for computing spheres) and 
<code>max_neighborhood_diameter
</code> (for computing neighborhoods). Otherwise, we use the raw maximal fold distance.
</li>
<li>Compute hierarchical clustering of the metacells using these distances and the 
<code>complete
</code> linkage; that is, each cluster can be seen as a sphere of some diameter where all the metacells are within that sphere.
</li>
<li>Use this hierarchical clustering to partition the metacells into as-large as possible spheres. If 
<code>max_deviant_genes
</code> is zero (the default), then this is 
<code>cutree
</code> using the 
<code>max_sphere_diameter
</code> (by default, 
<code>2.0
</code>, or 4x); otherwise, it is a 
<code>cutree
</code> using the 
<code>max_deviant_genes
</code>.
</li>
<li>Compute for each sphere the set of other spheres in its main neighborhood. If 
<code>max_deviant_genes
</code> is zero, this means the maximal distance between any pair of metacells is at most an additional 
<code>max_neighborhood_diameter
</code> (by default, 
<code>2.0
</code>, for a total neighborhood diameter of 16x). Otherwise, it means the maximal number of genes whose distance is more than this threshold in the metacells pair is at most 
<code>max_deviant_genes
</code>. Neighborhoods can overlap; also, if the main neighborhoods defined by two spheres end up being identical, we unify them, so we may end up with less neighborhoods than spheres.
</li>
<li>The distances to the other spheres in the main neighborhood of each sphere form a natural graph representation of the structure of the manifold of the distinct biological cell states captured by the metacells.
</li>
</ol>
<p>If 
<code>overwrite
</code> is set, the results will replace any previously computed spheres and neighborhoods.
</p>
<p>CONTRACT
</p>
</div>
</section>
</article>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Metacells.Spheres.improve_spheres!" href="#Metacells.Spheres.improve_spheres!">
<code>Metacells.Spheres.improve_spheres!
</code>
</a> — 
<span class="docstring-category">Function
</span>
</header>
<section>
<div>
<pre>
<code class="language-julia hljs">function improve_spheres!(
    daf::DafWriter;
    min_significant_gene_UMIs::Integer = 40,
    gene_fraction_regularization::AbstractFloat = 1e-5,
    confidence::AbstractFloat = 0.9,
    max_sphere_diameter::AbstractFloat = 2.0,
    max_neighborhood_diameter::AbstractFloat = 2.0,
    noisy_gene_fold::AbstractFloat = 1.0,
    min_gene_correlation::AbstractFloat = 0.5,
)::Nothing
</code>
</pre>
<p>Improve the partition raw metacells into distinct spheres, and spheres into overlapping neighborhoods. The improved partition ensures no gene is not &quot;too different&quot; between the metacells in each sphere and spheres in each neighborhood; however, this only applies to genes that have at least 
<code>min_gene_correlation
</code> with at least one other gene in the neighborhood.
</p>
<ol>
<li>Invoke 
<a href="identify_genes.html#Metacells.IdentifyGenes.identify_marker_genes!">
<code>identify_marker_genes!
</code>
</a> and 
<a href="identify_genes.html#Metacells.IdentifyGenes.identify_lonely_genes!">
<code>identify_lonely_genes!
</code>
</a> for each neighborhood and store the results in 
<code>is_marker
</code> and 
<code>is_lonely
</code> of the genes for the metacells in sphere for which this is the main neighborhood.
</li>
<li>Recompute the spheres with 
<code>max_deviant_genes = 0
</code> and 
<code>overwrite = true
</code>. When computing the distance between each two metacells, this will only consider genes that are markers in either metacell and are not lonely in both. The result should be &quot;improved&quot; spheres as they will not be affected by genes that aren&#39;t part of some multi-gene behavior relevant to each sphere&#39;s neighborhood.
</li>
</ol>
<p>CONTRACT
</p>
</div>
</section>
</article>
<h2 id="Index">
<a class="docs-heading-anchor" href="#Index">Index
</a>
<a id="Index-1">
</a>
<a class="docs-heading-anchor-permalink" href="#Index" title="Permalink">
</a>
</h2>
<ul>
<li>
<a href="spheres.html#Metacells.Spheres">
<code>Metacells.Spheres
</code>
</a>
</li>
<li>
<a href="spheres.html#Metacells.Spheres.compute_improved_spheres!">
<code>Metacells.Spheres.compute_improved_spheres!
</code>
</a>
</li>
<li>
<a href="spheres.html#Metacells.Spheres.compute_spheres!">
<code>Metacells.Spheres.compute_spheres!
</code>
</a>
</li>
<li>
<a href="spheres.html#Metacells.Spheres.improve_spheres!">
<code>Metacells.Spheres.improve_spheres!
</code>
</a>
</li>
</ul>
</article>
<nav class="docs-footer">
<a class="docs-footer-prevpage" href="identify_genes.html">« Identify Genes
</a>
<div class="flexbox-break">
</div>
<p class="footer-message">Powered by 
<a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl
</a> and the 
<a href="https://julialang.org/">Julia Programming Language
</a>.
</p>
</nav>
</div>
<div class="modal" id="documenter-settings">
<div class="modal-background">
</div>
<div class="modal-card">
<header class="modal-card-head">
<p class="modal-card-title">Settings
</p>
<button class="delete">
</button>
</header>
<section class="modal-card-body">
<p>
<label class="label">Theme
</label>
<div class="select">
<select id="documenter-themepicker">
<option value="auto">Automatic (OS)
</option>
<option value="documenter-light">documenter-light
</option>
<option value="documenter-dark">documenter-dark
</option>
</select>
</div>
</p>
<hr/>
<p>This document was generated with 
<a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl
</a> version 1.4.0. Using Julia version 1.10.0.
</p>
</section>
<footer class="modal-card-foot">
</footer>
</div>
</div>
</div>
</body>
</html>
