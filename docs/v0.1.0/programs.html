
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Programs · Metacells.jl v0.1.0
</title>
<meta name="title" content="Programs · Metacells.jl v0.1.0"/>
<meta property="og:title" content="Programs · Metacells.jl v0.1.0"/>
<meta property="twitter:title" content="Programs · Metacells.jl v0.1.0"/>
<meta name="description" content="Documentation for Metacells.jl v0.1.0."/>
<meta property="og:description" content="Documentation for Metacells.jl v0.1.0."/>
<meta property="twitter:description" content="Documentation for Metacells.jl v0.1.0."/>
<script data-outdated-warner src="assets/warner.js">
</script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/>
<script>documenterBaseURL="."
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js">
</script>
<script src="search_index.js">
</script>
<script src="siteinfo.js">
</script>
<script src="../versions.js">
</script>
<link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/>
<link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/>
<link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/>
<link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/>
<link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/>
<link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/>
<script src="assets/themeswap.js">
</script>
</head>
<body>
<div id="documenter">
<nav class="docs-sidebar">
<div class="docs-package-name">
<span class="docs-autofit">
<a href="index.html">Metacells.jl v0.1.0
</a>
</span>
</div>
<button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)
</button>
<ul class="docs-menu">
<li>
<a class="tocitem" href="index.html">Metacells
</a>
</li>
<li>
<a class="tocitem" href="gmara.html">Gmara
</a>
</li>
<li>
<a class="tocitem" href="contracts.html">Contracts
</a>
</li>
<li>
<a class="tocitem" href="identify_genes.html">Identify Genes
</a>
</li>
<li class="is-active">
<a class="tocitem" href="programs.html">Programs
</a>
<ul class="internal">
<li>
<a class="tocitem" href="#Index">
<span>Index
</span>
</a>
</li>
</ul>
</li>
<li>
<a class="tocitem" href="anndata_format.html">AnnData Format
</a>
</li>
<li>
<a class="tocitem" href="defaults.html">Defaults
</a>
</li>
</ul>
<div class="docs-version-selector field has-addons">
<div class="control">
<span class="docs-label button is-static is-size-7">Version
</span>
</div>
<div class="docs-selector control is-expanded">
<div class="select is-fullwidth is-size-7">
<select id="documenter-version-selector">
</select>
</div>
</div>
</div>
</nav>
<div class="docs-main">
<header class="docs-navbar">
<a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#">
</a>
<nav class="breadcrumb">
<ul class="is-hidden-mobile">
<li class="is-active">
<a href="programs.html">Programs
</a>
</li>
</ul>
<ul class="is-hidden-tablet">
<li class="is-active">
<a href="programs.html">Programs
</a>
</li>
</ul>
</nav>
<div class="docs-right">
<a class="docs-navbar-link" href="https://github.com/tanaylab/Metacells.jl/blob/main{path}?plain=1#L{line}" title="View the repository on GitHub">
<span class="docs-icon fa-brands">
</span>
<span class="docs-label is-hidden-touch">GitHub
</span>
</a>
<a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings">
</a>
<a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings">
</a>
</div>
</header>
<article class="content" id="documenter-page">
<h1 id="Programs">
<a class="docs-heading-anchor" href="#Programs">Programs
</a>
<a id="Programs-1">
</a>
<a class="docs-heading-anchor-permalink" href="#Programs" title="Permalink">
</a>
</h1>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Metacells.Programs" href="#Metacells.Programs">
<code>Metacells.Programs
</code>
</a> — 
<span class="docstring-category">Module
</span>
</header>
<section>
<div>
<p>Approximate the manifold of actual cell states (captured by metacells) using linear programs in each local region.
</p>
</div>
</section>
</article>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Metacells.Programs.compute_factor_priority_of_genes!" href="#Metacells.Programs.compute_factor_priority_of_genes!">
<code>Metacells.Programs.compute_factor_priority_of_genes!
</code>
</a> — 
<span class="docstring-category">Function
</span>
</header>
<section>
<div>
<pre>
<code class="language-julia hljs">function compute_factor_priority_of_genes!(
    daf::DafWriter;
    gene_fraction_regularization::AbstractFloat = 2.0e-5,
    max_principal_components::Integer = 40,
    factors_per_principal_component::Real = 2,
)::Nothing
</code>
</pre>
<p>Given the transcription factors in the data, identify an ordered subset of these to use as candidates for predicting the rest of the genes. To achieve this, we run PCA analysis with up to 
<code>max_principal_components
</code> on the log (base 2) of the gene expressions (using the 
<code>gene_fraction_regularization
</code>). We then rank each gene in each principal component (based on the absolute coefficient value) and compute the minimal rank of each gene (giving lower weight to genes in later components). We prioritize the transcription factors according to this minimal rank, choosing the top 
<code>factors_per_principal_component
</code> times the number of principal components.
</p>
<p>
<strong>Inputs
</strong>
</p>
<p>
<strong>Axes
</strong>
</p>
<p>
<strong>gene
</strong> (required): Sequenced genes.
</p>
<p>
<strong>metacell
</strong> (required): Minimal-sized groups of cells for robust point estimates.
</p>
<p>
<strong>Vectors
</strong>
</p>
<p>
<strong>gene @ divergence
</strong>::Union{Float32, Float64} (required): Scale fold factors of each gene by multiplying with (1 - divergence) of the gene.
</p>
<p>
<strong>gene @ is
<em>transcription
</em>factor
</strong>::Bool (required): A mask of genes that bind to the DNA.
</p>
<p>
<strong>gene @ is
<em>forbidden
</em>factor
</strong>::Bool (optional): A mask of genes that are forbidden from being used as predictive factors.
</p>
<p>
<strong>Matrices
</strong>
</p>
<p>
<strong>gene, metacell @ fraction
</strong>::Union{Float32, Float64} (required): The estimated fraction of the UMIs of each gene in each metacell.
</p>
<p>
<strong>Outputs
</strong>
</p>
<p>
<strong>Vectors
</strong>
</p>
<p>
<strong>gene @ factor_priority
</strong>::Union{UInt16, UInt32, UInt64, UInt8} (guaranteed): Priority for using the gene as a predictor for the rest of the genes.
</p>
</div>
</section>
</article>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Metacells.Programs.compute_global_predictive_factors!" href="#Metacells.Programs.compute_global_predictive_factors!">
<code>Metacells.Programs.compute_global_predictive_factors!
</code>
</a> — 
<span class="docstring-category">Function
</span>
</header>
<section>
<div>
<pre>
<code class="language-julia hljs">function compute_global_predictive_factors!(
    daf::DafWriter;
    gene_fraction_regularization::AbstractFloat = 2.0e-5,
    cross_validation::Integer = 5,
    rng::AbstractRNG = default_rng(),
)::Nothing
</code>
</pre>
<p>Given a prioritized subset of the factor genes likely to be predictive, identify a subset of these genes which best predict the values of the rest of the genes, using non-negative least-squares approximation using the log (base 2) of the genes expression (using the 
<code>gene_fraction_regularization
</code>). To avoid over-fitting, we use 
<code>cross_validation
</code>.
</p>
<p>We require each additional used factor to improve (reduce) the RMS of the cross validation error by at least 
<code>min_rms_improvement
</code> (on average). Factors with higher prioriry are allowed a lower improvement and factors with a lower priority require higher improvement; the range of this is 
<code>rms_priority_improvement
</code> times the 
<code>min_rms_improvement
</code>. That is, if this range is 1, then the highest priority factor requires 0.5 times the minimal improvement, and the lowest priority factor requires 1.5 times the minimal improvement.
</p>
<p>Since this prediction is global for the whole data set, we do not expect it to be useful as of itself. We therefore intentionally do not store the coefficients. Instead we only store the mask of chosen predictive factors.
</p>
<p>
<strong>Inputs
</strong>
</p>
<p>
<strong>Axes
</strong>
</p>
<p>
<strong>gene
</strong> (required): Sequenced genes.
</p>
<p>
<strong>metacell
</strong> (required): Minimal-sized groups of cells for robust point estimates.
</p>
<p>
<strong>Vectors
</strong>
</p>
<p>
<strong>gene @ divergence
</strong>::Union{Float32, Float64} (required): Scale fold factors of each gene by multiplying with (1 - divergence) of the gene.
</p>
<p>
<strong>gene @ factor_priority
</strong>::Union{UInt16, UInt32, UInt64, UInt8} (required): Priority for using the gene as a predictor for the rest of the genes.
</p>
<p>
<strong>Matrices
</strong>
</p>
<p>
<strong>gene, metacell @ fraction
</strong>::Union{Float32, Float64} (required): The estimated fraction of the UMIs of each gene in each metacell.
</p>
<p>
<strong>Outputs
</strong>
</p>
<p>
<strong>Vectors
</strong>
</p>
<p>
<strong>gene @ is
<em>global
</em>predictive_factor
</strong>::Bool (guaranteed): A mask of globally predictive transcription factors.
</p>
</div>
</section>
</article>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Metacells.Programs.compute_blocks!" href="#Metacells.Programs.compute_blocks!">
<code>Metacells.Programs.compute_blocks!
</code>
</a> — 
<span class="docstring-category">Function
</span>
</header>
<section>
<div>
<pre>
<code class="language-julia hljs">function compute_blocks!(
    daf::DafWriter;
    min_significant_gene_UMIs::Integer = 40,
    gene_fraction_regularization::AbstractFloat = 2.0e-5,
    fold_confidence::AbstractFloat = 0.9,
    max_block_span::Real = 2,
)::Nothing
</code>
</pre>
<p>Given a set of transcription factors that can be used to predict the rest of the genes across the whole manifold, group the metacells into distinct blocks, such that within each block, the expression level of all these factors differ by a fold factor of more than 
<code>max_block_span
</code> between any of the metacells of the block. When evaluating the difference in expression between the genes, we reduce the distance using the 
<code>fold_confidence
</code> based on the number of UMIs used to estimate the expression in the metacells; we also ignore any difference between the expression level of genes whose total UMIs (in both compared metacells) is less thabn 
<code>min_significant_gene_UMIs
</code>.
</p>
<p>We expect all the metacells within each block to be &quot;essentially identical&quot;, so blocks serve as a useful way to group metacells together for the purpose of type annotations. We also assume that the same local linear program applies for all metacells of each block. The distance matrix between the blocks expresses the overall structure of the manifold.
</p>
<p>
<strong>Inputs
</strong>
</p>
<p>
<strong>Axes
</strong>
</p>
<p>
<strong>gene
</strong> (required): Sequenced genes.
</p>
<p>
<strong>metacell
</strong> (required): Minimal-sized groups of cells for robust point estimates.
</p>
<p>
<strong>Vectors
</strong>
</p>
<p>
<strong>gene @ divergence
</strong>::Union{Float32, Float64} (required): Scale fold factors of each gene by multiplying with (1 - divergence) of the gene.
</p>
<p>
<strong>gene @ is
<em>global
</em>predictive_factor
</strong>::Bool (required): A mask of globally predictive transcription factors.
</p>
<p>
<strong>metacell @ total_UMIs
</strong>::Union{UInt16, UInt32, UInt64, UInt8} (required): The total number of UMIs used to estimate the fraction of all the genes in each metacell.
</p>
<p>
<strong>Matrices
</strong>
</p>
<p>
<strong>gene, metacell @ fraction
</strong>::Union{Float32, Float64} (required): The estimated fraction of the UMIs of each gene in each metacell.
</p>
<p>
<strong>gene, metacell @ total_UMIs
</strong>::Union{UInt16, UInt32, UInt64, UInt8} (required): The total number of UMIs used to estimate the fraction of each gene in each metacell.
</p>
<p>
<strong>Outputs
</strong>
</p>
<p>
<strong>Axes
</strong>
</p>
<p>
<strong>block
</strong> (guaranteed): Distinct groups of metacells with &quot;very close&quot; estimated cell state.
</p>
<p>
<strong>Vectors
</strong>
</p>
<p>
<strong>metacell @ block
</strong>::AbstractString (guaranteed): The unique block each metacell belongs to.
</p>
<p>
<strong>Matrices
</strong>
</p>
<p>
<strong>block, block @ distance
</strong>::Union{Float32, Float64} (guaranteed): The mean distance (maximal fold factor of any gene) between the metacells of the blocks.
</p>
</div>
</section>
</article>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Metacells.Programs.compute_blocks_vicinities!" href="#Metacells.Programs.compute_blocks_vicinities!">
<code>Metacells.Programs.compute_blocks_vicinities!
</code>
</a> — 
<span class="docstring-category">Function
</span>
</header>
<section>
<div>
<pre>
<code class="language-julia hljs">function compute_blocks_vicinities!(
    daf::DafWriter;
    gene_fraction_regularization::AbstractFloat = 2.0e-5,
    min_rms_improvement::AbstractFloat = 0.02,
    rms_priority_improvement::Real = 1,
    block_rms_bonus::AbstractFloat = 0.0005,
    cross_validation::Integer = 5,
    min_blocks_in_neighborhood::Integer = 4,
    min_metacells_in_neighborhood::Integer = 100,
    rng::AbstractRNG = default_rng(),
)::Nothing
</code>
</pre>
<p>Given a partition of the metacells into distinct blocks, compute for each block its immediate neighborhood (of at least 
<code>min_blocks_in_neighborhood
</code> blocks and at least 
<code>min_metacells_in_neighborhood
</code> metacells). Then expact this to an environment such that computing a linear model for the environment (based on the precomputed set of global predictive genes) minimizes the RMS of the error in the neighborhood.
</p>
<p>The motivation is that the small neighborhood is large enough to evaluate the linear model, but is too small by itself for detecting the linear model. Expanding the neighborhood to a larger environment allows us to detect weak linear programs that exist in the neighborhood, therefore reducing the RMS. Since the manifold is not linear, expanding the environment beyond a certain point starts to increase the RMS again. We give a slight bonus of 
<code>block_rms_bonus
</code> for per each block added to the environment to reduce the chances of stopping in a local minimum.
</p>
<p>
<strong>Inputs
</strong>
</p>
<p>
<strong>Axes
</strong>
</p>
<p>
<strong>gene
</strong> (required): Sequenced genes.
</p>
<p>
<strong>metacell
</strong> (required): Minimal-sized groups of cells for robust point estimates.
</p>
<p>
<strong>block
</strong> (required): Distinct groups of metacells with &quot;very close&quot; estimated cell state.
</p>
<p>
<strong>Vectors
</strong>
</p>
<p>
<strong>gene @ divergence
</strong>::Union{Float32, Float64} (required): Scale fold factors of each gene by multiplying with (1 - divergence) of the gene.
</p>
<p>
<strong>gene @ is
<em>global
</em>predictive_factor
</strong>::Bool (required): A mask of globally predictive transcription factors.
</p>
<p>
<strong>metacell @ block
</strong>::AbstractString (required): The unique block each metacell belongs to.
</p>
<p>
<strong>Matrices
</strong>
</p>
<p>
<strong>gene, metacell @ fraction
</strong>::Union{Float32, Float64} (required): The estimated fraction of the UMIs of each gene in each metacell.
</p>
<p>
<strong>block, block @ distance
</strong>::Union{Float32, Float64} (required): The mean distance (maximal fold factor of any gene) between the metacells of the blocks.
</p>
<p>
<strong>Outputs
</strong>
</p>
<p>
<strong>Matrices
</strong>
</p>
<p>
<strong>block, block @ is
<em>in
</em>neighborhood
</strong>::Bool (guaranteed): For each block, the mask of nearby blocks in its immediate neighborhood.
</p>
<p>
<strong>block, block @ is
<em>in
</em>environment
</strong>::Bool (guaranteed): For each block, the mask of nearby blocks in its linear environment.
</p>
</div>
</section>
</article>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Metacells.Programs.compute_local_predictive_factors!" href="#Metacells.Programs.compute_local_predictive_factors!">
<code>Metacells.Programs.compute_local_predictive_factors!
</code>
</a> — 
<span class="docstring-category">Function
</span>
</header>
<section>
<div>
<pre>
<code class="language-julia hljs">function compute_local_predictive_factors!(
    daf::DafWriter;
    gene_fraction_regularization::AbstractFloat = 2.0e-5,
    min_rms_improvement::AbstractFloat = 0.02,
    rms_priority_improvement::Real = 1,
    cross_validation::Integer = 5,
    min_marker_gene_range_fold::Real = 1,
    min_marker_gene_max_fraction::AbstractFloat = 0.0001,
    rng::AbstractRNG = default_rng(),
)::Nothing
</code>
</pre>
<p>Having computed the neighborhoods and environments, then for each block, figure out the set of transcription factors for best approximating the gene expression of the metacells in each neighborhood based on the environment. This set of local predictive factors will be different from the set of global predictive factors (and will be different for each block).
</p>
<p>When computing this set, we only consider the genes that are marker genes within the environment (as per 
<a href="identify_genes.html#Metacells.IdentifyGenes.identify_marker_genes!">
<code>identify_marker_genes!
</code>
</a>, using 
<code>min_marker_gene_max_fraction
</code> and a tighter 
<code>min_marker_gene_range_fold
</code>.
</p>
</div>
</section>
</article>
<h2 id="Index">
<a class="docs-heading-anchor" href="#Index">Index
</a>
<a id="Index-1">
</a>
<a class="docs-heading-anchor-permalink" href="#Index" title="Permalink">
</a>
</h2>
<ul>
<li>
<a href="programs.html#Metacells.Programs">
<code>Metacells.Programs
</code>
</a>
</li>
<li>
<a href="programs.html#Metacells.Programs.compute_blocks!">
<code>Metacells.Programs.compute_blocks!
</code>
</a>
</li>
<li>
<a href="programs.html#Metacells.Programs.compute_blocks_vicinities!">
<code>Metacells.Programs.compute_blocks_vicinities!
</code>
</a>
</li>
<li>
<a href="programs.html#Metacells.Programs.compute_factor_priority_of_genes!">
<code>Metacells.Programs.compute_factor_priority_of_genes!
</code>
</a>
</li>
<li>
<a href="programs.html#Metacells.Programs.compute_global_predictive_factors!">
<code>Metacells.Programs.compute_global_predictive_factors!
</code>
</a>
</li>
<li>
<a href="programs.html#Metacells.Programs.compute_local_predictive_factors!">
<code>Metacells.Programs.compute_local_predictive_factors!
</code>
</a>
</li>
</ul>
</article>
<nav class="docs-footer">
<a class="docs-footer-prevpage" href="identify_genes.html">« Identify Genes
</a>
<a class="docs-footer-nextpage" href="anndata_format.html">AnnData Format »
</a>
<div class="flexbox-break">
</div>
<p class="footer-message">Powered by 
<a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl
</a> and the 
<a href="https://julialang.org/">Julia Programming Language
</a>.
</p>
</nav>
</div>
<div class="modal" id="documenter-settings">
<div class="modal-background">
</div>
<div class="modal-card">
<header class="modal-card-head">
<p class="modal-card-title">Settings
</p>
<button class="delete">
</button>
</header>
<section class="modal-card-body">
<p>
<label class="label">Theme
</label>
<div class="select">
<select id="documenter-themepicker">
<option value="auto">Automatic (OS)
</option>
<option value="documenter-light">documenter-light
</option>
<option value="documenter-dark">documenter-dark
</option>
<option value="catppuccin-latte">catppuccin-latte
</option>
<option value="catppuccin-frappe">catppuccin-frappe
</option>
<option value="catppuccin-macchiato">catppuccin-macchiato
</option>
<option value="catppuccin-mocha">catppuccin-mocha
</option>
</select>
</div>
</p>
<hr/>
<p>This document was generated with 
<a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl
</a> version 1.5.0. Using Julia version 1.10.4.
</p>
</section>
<footer class="modal-card-foot">
</footer>
</div>
</div>
</div>
</body>
</html>
