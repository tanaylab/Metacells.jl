
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Boxes · Metacells.jl v0.1.0
</title>
<meta name="title" content="Boxes · Metacells.jl v0.1.0"/>
<meta property="og:title" content="Boxes · Metacells.jl v0.1.0"/>
<meta property="twitter:title" content="Boxes · Metacells.jl v0.1.0"/>
<meta name="description" content="Documentation for Metacells.jl v0.1.0."/>
<meta property="og:description" content="Documentation for Metacells.jl v0.1.0."/>
<meta property="twitter:description" content="Documentation for Metacells.jl v0.1.0."/>
<script data-outdated-warner src="assets/warner.js">
</script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/>
<script>documenterBaseURL="."
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js">
</script>
<script src="search_index.js">
</script>
<script src="siteinfo.js">
</script>
<script src="../versions.js">
</script>
<link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/>
<link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/>
<script src="assets/themeswap.js">
</script>
</head>
<body>
<div id="documenter">
<nav class="docs-sidebar">
<div class="docs-package-name">
<span class="docs-autofit">
<a href="index.html">Metacells.jl v0.1.0
</a>
</span>
</div>
<button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)
</button>
<ul class="docs-menu">
<li>
<a class="tocitem" href="index.html">Metacells
</a>
</li>
<li>
<a class="tocitem" href="contracts.html">Contracts
</a>
</li>
<li>
<a class="tocitem" href="identify_genes.html">Identify Genes
</a>
</li>
<li class="is-active">
<a class="tocitem" href="boxes.html">Boxes
</a>
<ul class="internal">
<li>
<a class="tocitem" href="#Index">
<span>Index
</span>
</a>
</li>
</ul>
</li>
<li>
<a class="tocitem" href="anndata_format.html">AnnData Format
</a>
</li>
</ul>
<div class="docs-version-selector field has-addons">
<div class="control">
<span class="docs-label button is-static is-size-7">Version
</span>
</div>
<div class="docs-selector control is-expanded">
<div class="select is-fullwidth is-size-7">
<select id="documenter-version-selector">
</select>
</div>
</div>
</div>
</nav>
<div class="docs-main">
<header class="docs-navbar">
<a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#">
</a>
<nav class="breadcrumb">
<ul class="is-hidden-mobile">
<li class="is-active">
<a href="boxes.html">Boxes
</a>
</li>
</ul>
<ul class="is-hidden-tablet">
<li class="is-active">
<a href="boxes.html">Boxes
</a>
</li>
</ul>
</nav>
<div class="docs-right">
<a class="docs-navbar-link" href="https://github.com/tanaylab/Metacells.jl/blob/main{path}?plain=1#L{line}" title="View the repository on GitHub">
<span class="docs-icon fa-brands">
</span>
<span class="docs-label is-hidden-touch">GitHub
</span>
</a>
<a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings">
</a>
<a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings">
</a>
</div>
</header>
<article class="content" id="documenter-page">
<h1 id="Boxes">
<a class="docs-heading-anchor" href="#Boxes">Boxes
</a>
<a id="Boxes-1">
</a>
<a class="docs-heading-anchor-permalink" href="#Boxes" title="Permalink">
</a>
</h1>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Metacells.Boxes" href="#Metacells.Boxes">
<code>Metacells.Boxes
</code>
</a> — 
<span class="docstring-category">Module
</span>
</header>
<section>
<div>
<p>Given a set of raw metacells, partition them into boxes such that all metacells in the same box are within some (fold factor) radius of each other. The centroids of these boxes can serve as a representation of the cell state manifold which is less sensitive to oversampling of common cell states. Group these boxes in overlapping neighborhoods of &quot;similar&quot; boxes for further analysis.
</p>
</div>
</section>
</article>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Metacells.Boxes.compute_boxes!" href="#Metacells.Boxes.compute_boxes!">
<code>Metacells.Boxes.compute_boxes!
</code>
</a> — 
<span class="docstring-category">Function
</span>
</header>
<section>
<div>
<pre>
<code class="language-julia hljs">function compute_boxes!(
    daf::DafWriter;
    min_significant_gene_UMIs::Integer = 40,
    gene_fraction_regularization::AbstractFloat = 1.0e-5,
    fold_confidence::AbstractFloat = 0.9,
    max_box_span::AbstractFloat = 2.0,
    max_neighborhood_span::AbstractFloat = 0.01,
    correlation_confidence::AbstractFloat = 0.9,
    max_deviant_genes_fraction::AbstractFloat = 0.01,
    overwrite::Bool = false,
)::Nothing
</code>
</pre>
<p>Partition raw metacells into distinct boxes, and boxes into overlapping neighborhoods.
</p>
<ol>
<li>Initial boxes and neighborhoods are computed in a first round, and then refined in a series of followup rounds.
</li>
<li>In each round, we compute a distance between each two metacells. This is based on the fold factor between the expression level of each (relevant) gene in the metacells. The fold factor is the absolute value of the difference in the log (base 2) of the fraction of the gene in the metacells. This log is computed with the 
<code>gene_fraction_regularization
</code> (by default, 
<code>1e-5
</code>). Since the fraction of the gene is a random variable, we decrease the high fraction and increase the low fraction by a factor based on the 
<code>fold_confidence
</code> of the test (by default, 0.9), assuming a multinomial distribution. In addition, if the sum of the total UMIs of the gene in both metacells is less than 
<code>min_significant_gene_UMIs
</code> (by default, 
<code>40
</code>), we ignore this fold factor as insignificant. Finally, genes, we reduce the fold factor using the gene&#39;s divergence factor. In the first round, we simply count the number of genes whose fold factor is more than 
<code>max_box_span
</code> (for computing boxes) and 
<code>max_box_span
</code> + 
<code>max_neighborhood_span
</code> (for computing neighborhoods). In the followup rounds, we use the maximal gene fold, for genes that are correlated in the vicinity of the metacells (see below). Finally, in the followup rounds, we only compare a base metacell with other metacells which were in the same neighborhood in the previous round.
</li>
<li>We use hierarchical clustering to partition the metacells to distinct boxes, such that the maximal distance between any metacells in the box is bounded. In the first round, this bound is the 
<code>max_deviant_genes_fraction
</code> out of the total number of genes. In the followup rounds, this is the 
<code>max_box_span
</code>.
</li>
<li>For each box, we compute a main neighborhood of other boxes such that the maximal distance between any metacells in the neighborhood is bounded. In the first round, this bound is again the maximal number of deviant genes (this time, using the increased fold distance computed above). In the followup rounds, this is the 
<code>max_box_span
</code> plus the 
<code>max_neighborhood_span
</code>. These neighborhoods may overlap. The main neighborhoods of different boxes may even be identical.
</li>
<li>For each box, we compute the set of genes which are correlated (using the 
<code>correlation_confidence
</code>) with some other gene(s) in its main neighborhood.
</li>
<li>If the new sets of correlated genes only differ up to 
<code>max_convergence_fraction
</code>, consider this to have converged. Otherwise, repeat from step 2.
</li>
</ol>
<p>If 
<code>overwrite
</code> is set, the results will replace any previously computed boxes and neighborhoods.
</p>
<p>
<strong>Inputs
</strong>
</p>
<p>
<strong>Axes
</strong>
</p>
<p>
<strong>gene
</strong> (required): Sequenced genes.
</p>
<p>
<strong>metacell
</strong> (required): Minimal-sized groups of cells for robust point estimates.
</p>
<p>
<strong>Vectors
</strong>
</p>
<p>
<strong>gene @ divergence
</strong>::Union{Float32, Float64} (required): Scale fold factors of each gene by multiplying with (1 - divergence) of the gene.
</p>
<p>
<strong>metacell @ total_UMIs
</strong>::Union{UInt16, UInt32, UInt64, UInt8} (required): The total number of UMIs used to estimate the fraction of all the genes in each metacell.
</p>
<p>
<strong>Matrices
</strong>
</p>
<p>
<strong>gene, metacell @ fraction
</strong>::Union{Float32, Float64} (required): The estimated fraction of the UMIs of each gene in each metacell.
</p>
<p>
<strong>gene, metacell @ total_UMIs
</strong>::Union{UInt16, UInt32, UInt64, UInt8} (required): The total number of UMIs used to estimate the fraction of each gene in each metacell.
</p>
<p>
<strong>Outputs
</strong>
</p>
<p>
<strong>Axes
</strong>
</p>
<p>
<strong>box
</strong> (guaranteed): Distinct groups of metacells with &quot;very close&quot; estimated cell state.
</p>
<p>
<strong>neighborhood
</strong> (guaranteed): Overlapping groups of boxes with &quot;close&quot; estimated cell states.
</p>
<p>
<strong>Vectors
</strong>
</p>
<p>
<strong>metacell @ box
</strong>::AbstractString (guaranteed): The unique box each metacell belongs to.
</p>
<p>
<strong>box @ neighborhood.main
</strong>::AbstractString (guaranteed): The unique main neighborhood of each box.
</p>
<p>
<strong>neighborhood @ span
</strong>::Union{Float32, Float64} (guaranteed): The span (fold factor) used to compute the neighborhood.
</p>
<p>
<strong>Matrices
</strong>
</p>
<p>
<strong>gene, neighborhood @ is_correlated
</strong>::Bool (guaranteed): Which genes are correlated in each neighborhood.
</p>
<p>
<strong>box, box @ distance
</strong>::Union{Float32, Float64} (guaranteed): The distance (fold factor) between the most different metacell genes between the boxes.
</p>
<p>
<strong>box, neighborhood @ is_member
</strong>::Bool (guaranteed): A mask of the member boxes of each neighborhood.
</p>
</div>
</section>
</article>
<article class="docstring">
<header>
<a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring">
</a>
<a class="docstring-binding" id="Metacells.Boxes.compute_boxes_data!" href="#Metacells.Boxes.compute_boxes_data!">
<code>Metacells.Boxes.compute_boxes_data!
</code>
</a> — 
<span class="docstring-category">Function
</span>
</header>
<section>
<div>
<pre>
<code class="language-julia hljs">function compute_boxes_data!(daf::DafWriter)::Nothing
</code>
</pre>
<p>Compute aggregated per-box data based on per-metacell data. This is separated from 
<a href="boxes.html#Metacells.Boxes.compute_boxes!">
<code>compute_boxes!
</code>
</a> to allow computing this data for all genes (instead of just for the subset of genes fed to 
<a href="boxes.html#Metacells.Boxes.compute_boxes!">
<code>compute_boxes!
</code>
</a>).
</p>
<p>
<strong>Inputs
</strong>
</p>
<p>
<strong>Axes
</strong>
</p>
<p>
<strong>gene
</strong> (required): Sequenced genes.
</p>
<p>
<strong>metacell
</strong> (required): Minimal-sized groups of cells for robust point estimates.
</p>
<p>
<strong>box
</strong> (required): Distinct groups of metacells with &quot;very close&quot; estimated cell state.
</p>
<p>
<strong>Matrices
</strong>
</p>
<p>
<strong>gene, metacell @ fraction
</strong>::Union{Float32, Float64} (required): The estimated fraction of the UMIs of each gene in each metacell.
</p>
<p>
<strong>gene, metacell @ total_UMIs
</strong>::Union{UInt16, UInt32, UInt64, UInt8} (required): The total number of UMIs used to estimate the fraction of each gene in each metacell.
</p>
<p>
<strong>Outputs
</strong>
</p>
<p>
<strong>Matrices
</strong>
</p>
<p>
<strong>gene, box @ fraction
</strong>::Union{Float32, Float64} (guaranteed): The estimated fraction of the UMIs of each gene in each box.
</p>
<p>
<strong>gene, box @ total_UMIs
</strong>::Union{UInt16, UInt32, UInt64, UInt8} (guaranteed): The total number of UMIs used to estimate the fraction of each gene in each box.
</p>
</div>
</section>
</article>
<h2 id="Index">
<a class="docs-heading-anchor" href="#Index">Index
</a>
<a id="Index-1">
</a>
<a class="docs-heading-anchor-permalink" href="#Index" title="Permalink">
</a>
</h2>
<ul>
<li>
<a href="boxes.html#Metacells.Boxes">
<code>Metacells.Boxes
</code>
</a>
</li>
<li>
<a href="boxes.html#Metacells.Boxes.compute_boxes!">
<code>Metacells.Boxes.compute_boxes!
</code>
</a>
</li>
<li>
<a href="boxes.html#Metacells.Boxes.compute_boxes_data!">
<code>Metacells.Boxes.compute_boxes_data!
</code>
</a>
</li>
</ul>
</article>
<nav class="docs-footer">
<a class="docs-footer-prevpage" href="identify_genes.html">« Identify Genes
</a>
<a class="docs-footer-nextpage" href="anndata_format.html">AnnData Format »
</a>
<div class="flexbox-break">
</div>
<p class="footer-message">Powered by 
<a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl
</a> and the 
<a href="https://julialang.org/">Julia Programming Language
</a>.
</p>
</nav>
</div>
<div class="modal" id="documenter-settings">
<div class="modal-background">
</div>
<div class="modal-card">
<header class="modal-card-head">
<p class="modal-card-title">Settings
</p>
<button class="delete">
</button>
</header>
<section class="modal-card-body">
<p>
<label class="label">Theme
</label>
<div class="select">
<select id="documenter-themepicker">
<option value="auto">Automatic (OS)
</option>
<option value="documenter-light">documenter-light
</option>
<option value="documenter-dark">documenter-dark
</option>
</select>
</div>
</p>
<hr/>
<p>This document was generated with 
<a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl
</a> version 1.4.1. Using Julia version 1.10.4.
</p>
</section>
<footer class="modal-card-foot">
</footer>
</div>
</div>
</div>
</body>
</html>
